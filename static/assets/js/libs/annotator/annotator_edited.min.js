((function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q=Array.prototype.slice,r=Object.prototype.hasOwnProperty,s=function(a,b){return function(){return a.apply(b,arguments)}},t=function(a,b){function d(){this.constructor=a}for(var c in b)r.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a};g=null,typeof Gettext!="undefined"&&Gettext!==null?(j=new Gettext({domain:"annotator"}),g=function(a){return j.gettext(a)}):g=function(a){return a},p=function(a){return g(a)},(typeof jQuery!="undefined"&&jQuery!==null?(o=jQuery.fn)!=null?o.jquery:void 0:void 0)||console.error(p("Annotator requires jQuery: have you included lib/vendor/jquery.js?")),JSON&&JSON.parse&&JSON.stringify||console.error(p("Annotator requires a JSON implementation: have you included lib/vendor/json2.js?")),a=jQuery.sub(),a.flatten=function(b){var c;return c=function(b){var d,e,f,g;e=[];for(f=0,g=b.length;f<g;f++)d=b[f],e=e.concat(d&&a.isArray(d)?c(d):d);return e},c(b)},a.plugin=function(b,c){return jQuery.fn[b]=function(d){var e;return e=Array.prototype.slice.call(arguments,1),this.each(function(){var f;return f=a.data(this,b),f?d&&f[d].apply(f,e):(f=new c(this,d),a.data(this,b,f))})}},a.fn.textNodes=function(){var b;return b=function(a){var c;if(a&&a.nodeType!==3){c=[];if(a.nodeType!==8){a=a.lastChild;while(a)c.push(b(a)),a=a.previousSibling}return c.reverse()}return a},this.map(function(){return a.flatten(b(this))})},a.fn.xpath=function(b){var c;return c=this.map(function(){var c,d,e;e="",c=this;while(c&&c.nodeType===1&&c!==b)d=a(c.parentNode).children(c.tagName).index(c)+1,d=d>1?"["+d+"]":"",e="/"+c.tagName.toLowerCase()+d+e,c=c.parentNode;return e}),c.get()},a.escape=function(a){return a.replace(/&(?!\w+;)/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},a.fn.escape=function(b){return arguments.length?this.html(a.escape(b)):this.html()},f=["log","debug","info","warn","exception","assert","dir","dirxml","trace","group","groupEnd","groupCollapsed","time","timeEnd","profile","profileEnd","count","clear","table","error","notifyFirebug","firebug","userObjects"];if(typeof console!="undefined"&&console!==null){console.group==null&&(console.group=function(a){return console.log("GROUP: ",a)}),console.groupCollapsed==null&&(console.groupCollapsed=console.group);for(k=0,m=f.length;k<m;k++)e=f[k],console[e]==null&&(console[e]=function(){return console.log(p("Not implemented:")+(" console."+name))})}else{this.console={};for(l=0,n=f.length;l<n;l++)e=f[l],this.console[e]=function(){};this.console.error=function(){var a;return a=1<=arguments.length?q.call(arguments,0):[],alert("ERROR: "+a.join(", "))},this.console.warn=function(){var a;return a=1<=arguments.length?q.call(arguments,0):[],alert("WARNING: "+a.join(", "))}}c=function(){function b(b,c){this.options=a.extend(!0,{},this.options,c),this.element=a(b),this.on=this.subscribe,this.addEvents()}return b.prototype.events={},b.prototype.options={},b.prototype.element=null,b.prototype.addEvents=function(){var a,b,c,d,e,f,g,h;f=this.events,h=[];for(c in f)b=f[c],g=c.split(" "),d=2<=g.length?q.call(g,0,e=g.length-1):(e=0,[]),a=g[e++],h.push(this.addEvent(d.join(" "),a,b));return h},b.prototype.addEvent=function(b,c,d){var e,f,g=this;return e=function(){return g[d].apply(g,arguments)},f=typeof b=="string"&&b.replace(/\s+/g,"")==="",f&&(b=this.element),typeof b=="string"?this.element.delegate(b,c,e):this.isCustomEvent(c)?this.subscribe(c,e):a(b).bind(c,e),this},b.prototype.isCustomEvent=function(c){return c=c.split(".")[0],a.inArray(c,b.natives)===-1},b.prototype.publish=function(){return this.element.triggerHandler.apply(this.element,arguments),this},b.prototype.subscribe=function(b,c){var d;return d=function(){return c.apply(this,[].slice.call(arguments,1))},d.guid=c.guid=a.guid+=1,this.element.bind(b,d),this},b.prototype.unsubscribe=function(){return this.element.unbind.apply(this.element,arguments),this},b}(),c.natives=function(){var a,b,c;return b=function(){var b,d;b=jQuery.event.special,d=[];for(a in b){if(!r.call(b,a))continue;c=b[a],d.push(a)}return d}(),"blur focus focusin focusout load resize scroll unload click dblclick\nmousedown mouseup mousemove mouseover mouseout mouseenter mouseleave\nchange select submit keydown keypress keyup error".split(/[^a-z]+/).concat(b)}(),d={},d.sniff=function(a){return a.commonAncestorContainer!=null?new d.BrowserRange(a):typeof a.start=="string"?new d.SerializedRange(a):a.start&&typeof a.start=="object"?new d.NormalizedRange(a):(console.error(p("Could not sniff range type")),!1)},d.BrowserRange=function(){function a(a){this.commonAncestorContainer=a.commonAncestorContainer,this.startContainer=a.startContainer,this.startOffset=a.startOffset,this.endContainer=a.endContainer,this.endOffset=a.endOffset}return a.prototype.normalize=function(a){var b,c,e,f,g,h,i,j,k;if(this.tainted)return console.error(p("You may only call normalize() once on a BrowserRange!")),!1;this.tainted=!0,h={},e={},k=["start","end"];for(i=0,j=k.length;i<j;i++){g=k[i],c=this[g+"Container"],f=this[g+"Offset"];if(c.nodeType===1){b=c.childNodes[f],c=b||c.childNodes[f-1],c.nodeType===1&&!c.firstChild&&(b=null,c=c.previousSibling);while(c.nodeType!==3)c=c.firstChild;f=b?0:c.nodeValue.length}h[g]=c,h[g+"Offset"]=f}e.start=h.startOffset>0?h.start.splitText(h.startOffset):h.start,h.start===h.end?(h.endOffset-h.startOffset<e.start.nodeValue.length&&e.start.splitText(h.endOffset-h.startOffset),e.end=e.start):(h.endOffset<h.end.nodeValue.length&&h.end.splitText(h.endOffset),e.end=h.end),e.commonAncestor=this.commonAncestorContainer;while(e.commonAncestor.nodeType!==1)e.commonAncestor=e.commonAncestor.parentNode;return new d.NormalizedRange(e)},a.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},a}(),d.NormalizedRange=function(){function b(a){this.commonAncestor=a.commonAncestor,this.start=a.start,this.end=a.end}return b.prototype.normalize=function(a){return this},b.prototype.limit=function(b){var c,d,e,f,g,h;c=a.grep(this.textNodes(),function(c){return c.parentNode===b||a.contains(b,c.parentNode)});if(!c.length)return null;this.start=c[0],this.end=c[c.length-1],e=a(this.start).parents(),h=a(this.end).parents();for(f=0,g=h.length;f<g;f++){d=h[f];if(e.index(d)!==-1){this.commonAncestor=d;break}}return this},b.prototype.serialize=function(b,c){var e,f,g;return f=function(d,e){var f,g,h,i,j,k,l,m;c?i=a(d).parents(":not("+c+")").eq(0):i=a(d).parent(),k=i.xpath(b)[0],j=i.textNodes(),g=j.slice(0,j.index(d)),h=0;for(l=0,m=g.length;l<m;l++)f=g[l],h+=f.nodeValue.length;return e?[k,h+d.nodeValue.length]:[k,h]},g=f(this.start),e=f(this.end,!0),new d.SerializedRange({start:g[0],end:e[0],startOffset:g[1],endOffset:e[1]})},b.prototype.text=function(){var a;return function(){var b,c,d,e;d=this.textNodes(),e=[];for(b=0,c=d.length;b<c;b++)a=d[b],e.push(a.nodeValue);return e}.call(this).join("")},b.prototype.textNodes=function(){var b,c,d,e;return d=a(this.commonAncestor).textNodes(),e=[d.index(this.start),d.index(this.end)],c=e[0],b=e[1],a.makeArray(d.slice(c,b+1||9e9))},b.prototype.toRange=function(){var a;return a=document.createRange(),a.setStartBefore(this.start),a.setEndAfter(this.end),a},b}(),d.SerializedRange=function(){function b(a){this.start=a.start,this.startOffset=a.startOffset,this.end=a.end,this.endOffset=a.endOffset}return b.prototype._nodeFromXPath=function(b){var c,d,e,f,g;return d=function(a,b){return b==null&&(b=null),document.evaluate(a,document,b,XPathResult.FIRST_ORDERED_NODE_TYPE,null).singleNodeValue},a.isXMLDoc(document.documentElement)?(c=document.createNSResolver(document.ownerDocument===null?document.documentElement:document.ownerDocument.documentElement),f=d(b,c),f||(b=function(){var a,c,d,e;d=b.split("/"),e=[];for(a=0,c=d.length;a<c;a++)g=d[a],g&&g.indexOf(":")===-1?e.push(g.replace(/^([a-z]+)/,"xhtml:$1")):e.push(g);return e}().join("/"),e=document.lookupNamespaceURI(null),c=function(a){return a==="xhtml"?e:document.documentElement.getAttribute("xmlns:"+a)},f=d(b,c)),f):d(b)},b.prototype.normalize=function(b){var c,e,f,g,h,i,j,k,l,m,n,o,q,r,s,t,u;j=a(b).xpath()[0],l=this.start.split("/"),f=this.end.split("/"),e=[],k={};for(g=0,s=l.length;0<=s?g<s:g>s;0<=s?g++:g--){if(l[g]!==f[g])break;e.push(l[g])}c=j+e.join("/"),k.commonAncestorContainer=this._nodeFromXPath(c);if(!k.commonAncestorContainer)return console.error(p("Error deserializing range: can't find XPath '")+c+p("'. Is this the right document?")),null;t=["start","end"];for(n=0,q=t.length;n<q;n++){i=t[n],h=0,u=a(this._nodeFromXPath(j+this[i])).textNodes();for(o=0,r=u.length;o<r;o++){m=u[o];if(h+m.nodeValue.length>=this[i+"Offset"]){k[i+"Container"]=m,k[i+"Offset"]=this[i+"Offset"]-h;break}h+=m.nodeValue.length}}return(new d.BrowserRange(k)).normalize(b)},b.prototype.serialize=function(a,b){return this.normalize(a).serialize(a,b)},b.prototype.toObject=function(){return{start:this.start,startOffset:this.startOffset,end:this.end,endOffset:this.endOffset}},b}(),h={uuid:function(){var a;return a=0,function(){return a++}}(),getGlobal:function(){return function(){return this}()},mousePosition:function(b,c){var d;return d=a(c).offset(),{top:b.pageY-d.top,left:b.pageX-d.left}},preventEventDefault:function(a){return a!=null?typeof a.preventDefault=="function"?a.preventDefault():void 0:void 0}},i=this.Annotator,b=function(b){function c(b,d){this.onDeleteAnnotation=s(this.onDeleteAnnotation,this),this.onEditAnnotation=s(this.onEditAnnotation,this),this.onAdderClick=s(this.onAdderClick,this),this.onAdderMousedown=s(this.onAdderMousedown,this),this.onHighlightMouseover=s(this.onHighlightMouseover,this),this.checkForEndSelection=s(this.checkForEndSelection,this),this.checkForStartSelection=s(this.checkForStartSelection,this),this.clearViewerHideTimer=s(this.clearViewerHideTimer,this),this.startViewerHideTimer=s(this.startViewerHideTimer,this),this.showViewer=s(this.showViewer,this),this.onEditorSubmit=s(this.onEditorSubmit,this),this.onEditorHide=s(this.onEditorHide,this),this.showEditor=s(this.showEditor,this);var e,f,g;c.__super__.constructor.apply(this,arguments),this.plugins={};if(!c.supported())return this;this._setupDocumentEvents()._setupWrapper()._setupViewer()._setupEditor(),g=this.html;for(e in g)f=g[e],e!=="wrapper"&&(this[e]=a(f).appendTo(this.wrapper).hide())}return t(c,b),c.prototype.events={".annotator-adder button click":"onAdderClick",".annotator-adder button mousedown":"onAdderMousedown"/*,".annotator-hl mouseover":"onHighlightMouseover"*/,".annotator-hl mouseout":"startViewerHideTimer"},c.prototype.html={hl:'<span class="annotator-hl"></span>',adder:'<div class="annotator-adder"><button>'+p("Annotate")+"</button></div>",wrapper:'<div class="annotator-wrapper"></div>'},c.prototype.options={},c.prototype.plugins={},c.prototype.editor=null,c.prototype.viewer=null,c.prototype.selectedRanges=null,c.prototype.mouseIsDown=!1,c.prototype.ignoreMouseup=!1,c.prototype.viewerHideTimer=null,c.prototype._setupWrapper=function(){return this.wrapper=a(this.html.wrapper),this.element.find("script").remove(),this.element.wrapInner(this.wrapper),this.wrapper=this.element.find(".annotator-wrapper"),this},c.prototype._setupViewer=function(){var b=this;return this.viewer=new c.Viewer,this.viewer.hide().on("edit",this.onEditAnnotation).on("delete",this.onDeleteAnnotation).addField({load:function(c,d){return d.text?a(c).escape(d.text):a(c).html("<i>"+p("No Comment")+"</i>"),b.publish("annotationViewerTextField",[c,d])}}).element.appendTo(this.wrapper).bind({mouseover:this.clearViewerHideTimer,mouseout:this.startViewerHideTimer}),this},c.prototype._setupEditor=function(){return this.editor=new c.Editor,this.editor.hide().on("hide",this.onEditorHide).on("save",this.onEditorSubmit).addField({type:"textarea",label:p("Comments")+"…",load:function(b,c){return a(b).find("textarea").val(c.text||"")},submit:function(b,c){return c.text=a(b).find("textarea").val()}}),this.editor.element.appendTo(this.wrapper),this},c.prototype._setupDocumentEvents=function(){return a(document).bind({mouseup:this.checkForEndSelection,mousedown:this.checkForStartSelection}),this},c.prototype.getSelectedRanges=function(){var b,c,e,f;return f=h.getGlobal().getSelection(),e=[],f.isCollapsed||(e=function(){var a,e;e=[];for(c=0,a=f.rangeCount;0<=a?c<a:c>a;0<=a?c++:c--)b=new d.BrowserRange(f.getRangeAt(c)),e.push(b.normalize().limit(this.wrapper[0]));return e}.call(this),f.removeAllRanges()),a.grep(e,function(a){return a&&f.addRange(a.toRange()),a})},c.prototype.createAnnotation=function(){var a;return a={},this.publish("beforeAnnotationCreated",[a]),a},c.prototype.setupAnnotation=function(b,c){var e,f,g,h,i,j;c==null&&(c=!0),b.ranges||(b.ranges=this.selectedRanges),f=function(){var a,c,e,f;e=b.ranges,f=[];for(a=0,c=e.length;a<c;a++)g=e[a],h=d.sniff(g),f.push(h.normalize(this.wrapper[0]));return f}.call(this),f=a.grep(f,function(a){return a!==null}),b.quote=[],b.ranges=[],b.highlights=[];for(i=0,j=f.length;i<j;i++)e=f[i],b.quote.push(a.trim(e.text())),b.ranges.push(e.serialize(this.wrapper[0],".annotator-hl")),a.merge(b.highlights,this.highlightRange(e));return b.quote=b.quote.join(" / "),a(b.highlights).data("annotation",b),c&&this.publish("annotationCreated",[b]),b},c.prototype.updateAnnotation=function(a){return this.publish("beforeAnnotationUpdated",[a]),this.publish("annotationUpdated",[a]),a},c.prototype.deleteAnnotation=function(b){var c,d,e,f;f=b.highlights;for(d=0,e=f.length;d<e;d++)c=f[d],a(c).replaceWith(c.childNodes);return this.publish("annotationDeleted",[b]),b},c.prototype.loadAnnotations=function(a){var b,c,d=this;return a==null&&(a=[]),c=function(a){var e,f,g,h;a==null&&(a=[]),f=a.splice(0,10);for(g=0,h=f.length;g<h;g++)e=f[g],d.setupAnnotation(e,!1);return a.length>0?setTimeout(function(){return c(a)},100):d.publish("annotationsLoaded",[b])},b=a.slice(),a.length&&c(a),this},c.prototype.dumpAnnotations=function(){return this.plugins.Store?this.plugins.Store.dumpAnnotations():console.warn(p("Can't dump annotations without Store plugin."))},c.prototype.highlightRange=function(b){var c,d,e,f,g,h;d=/^\s*$/,g=b.textNodes(),h=[];for(e=0,f=g.length;e<f;e++)c=g[e],d.test(c.nodeValue)||h.push(a(c).wrapAll(this.hl).parent().show()[0]);return h},c.prototype.addPlugin=function(a,b){var d,e;return this.plugins[a]?console.error(p("You cannot have more than one instance of any plugin.")):(d=c.Plugin[a],typeof d=="function"?(this.plugins[a]=new d(this.element[0],b),this.plugins[a].annotator=this,typeof (e=this.plugins[a]).pluginInit=="function"&&e.pluginInit()):console.error(p("Could not load ")+a+p(" plugin. Have you included the appropriate <script> tag?"))),this},c.prototype.showEditor=function(a,b){return this.editor.element.css(b),this.editor.load(a),this},c.prototype.onEditorHide=function(){return this.publish("annotationEditorHidden",[this.editor]),this.ignoreMouseup=!1},c.prototype.onEditorSubmit=function(a){return this.publish("annotationEditorSubmit",[this.editor,a]),a.ranges===void 0?this.setupAnnotation(a):this.updateAnnotation(a)},c.prototype.showViewer=function(a,b){return this.viewer.element.css(b),this.viewer.load(a),this.publish("annotationViewerShown",[this.viewer,a])},c.prototype.startViewerHideTimer=function(){if(!this.viewerHideTimer)return this.viewerHideTimer=setTimeout(this.viewer.hide,250)},c.prototype.clearViewerHideTimer=function(){return clearTimeout(this.viewerHideTimer),this.viewerHideTimer=!1},c.prototype.checkForStartSelection=function(a){if(!a||!this.isAnnotator(a.target))return this.startViewerHideTimer(),this.mouseIsDown=!0},c.prototype.checkForEndSelection=function(a){var b,c,d,e,f;this.mouseIsDown=!1;if(this.ignoreMouseup)return;this.selectedRanges=this.getSelectedRanges(),f=this.selectedRanges;for(d=0,e=f.length;d<e;d++){c=f[d],b=c.commonAncestor;if(this.isAnnotator(b))return}return a&&this.selectedRanges.length?this.adder.css(h.mousePosition(a,this.wrapper[0])).show():this.adder.hide()},c.prototype.isAnnotator=function(b){return!!a(b).parents().andSelf().filter("[class^=annotator-]").not(this.wrapper).length},c.prototype.onHighlightMouseover=function(b){var c;return this.clearViewerHideTimer(),this.mouseIsDown||this.viewer.isShown()?!1:(c=a(b.target).parents(".annotator-hl").andSelf().map(function(){return a(this).data("annotation")}),this.showViewer(a.makeArray(c),h.mousePosition(b,this.wrapper[0])))},c.prototype.onAdderMousedown=function(a){return a!=null&&a.preventDefault(),this.ignoreMouseup=!0},c.prototype.onAdderClick=function(a){var b;return a!=null&&a.preventDefault(),b=this.adder.position(),this.adder.hide(),this.showEditor(this.createAnnotation(),b)},c.prototype.onEditAnnotation=function(a){var b;return b=this.viewer.element.position(),this.viewer.hide(),this.showEditor(a,b)},c.prototype.onDeleteAnnotation=function(a){return this.viewer.hide(),this.deleteAnnotation(a)},c}(c),b.Plugin=function(a){function b(a,c){b.__super__.constructor.apply(this,arguments)}return t(b,a),b.prototype.pluginInit=function(){},b}(c),b.$=a,b.Delegator=c,b.Range=d,b._t=p,b.supported=function(){return function(){return!!this.getSelection}()},b.noConflict=function(){return h.getGlobal().Annotator=i,this},a.plugin("annotator",b),this.Annotator=b,b.Widget=function(c){function d(c,e){d.__super__.constructor.apply(this,arguments),this.classes=a.extend({},b.Widget.prototype.classes,this.classes)}return t(d,c),d.prototype.classes={hide:"annotator-hide",invert:{x:"annotator-invert-x",y:"annotator-invert-y"}},d.prototype.checkOrientation=function(){var b,c,d,e,f;return this.resetOrientation(),f=a(h.getGlobal()),e=this.element.children(":first"),c=e.offset(),d={top:f.scrollTop(),right:f.width()+f.scrollLeft()},b={top:c.top,right:c.left+e.width()},b.top-d.top<0&&this.invertY(),b.right-d.right>0&&this.invertX(),this},d.prototype.resetOrientation=function(){return this.element.removeClass(this.classes.invert.x).removeClass(this.classes.invert.y),this},d.prototype.invertX=function(){return this.element.addClass(this.classes.invert.x),this},d.prototype.invertY=function(){return this.element.addClass(this.classes.invert.y),this},d.prototype.isInvertedY=function(){return this.element.hasClass(this.classes.invert.y)},d.prototype.isInvertedX=function(){return this.element.hasClass(this.classes.invert.x)},d}(c),b.Editor=function(b){function c(b){this.onCancelButtonMouseover=s(this.onCancelButtonMouseover,this),this.processKeypress=s(this.processKeypress,this),this.submit=s(this.submit,this),this.load=s(this.load,this),this.hide=s(this.hide,this),this.show=s(this.show,this),c.__super__.constructor.call(this,a(this.html)[0],b),this.fields=[],this.annotation={},this.setupDraggables()}return t(c,b),c.prototype.events={"form submit":"submit",".annotator-save click":"submit",".annotator-cancel click":"hide",".annotator-cancel mouseover":"onCancelButtonMouseover","textarea keydown":"processKeypress"},c.prototype.classes={hide:"annotator-hide",focus:"annotator-focus"},c.prototype.html='<div class="annotator-outer annotator-editor">\n  <form class="annotator-widget">\n    <ul class="annotator-listing"></ul>\n    <div class="annotator-controls">\n      <a href="#cancel" class="annotator-cancel">'+p("Cancel")+'</a>\n<a href="#save" class="annotator-save annotator-focus">'+p("Save")+'</a>\n    </div>\n    <span class="annotator-resize"></span>\n  </form>\n</div>',c.prototype.options={},c.prototype.show=function(a){var b;return h.preventEventDefault(a),this.element.removeClass(this.classes.hide),this.element.find(".annotator-save").addClass(this.classes.focus),this.checkOrientation(),b=this.isInvertedY()?":last":":first",this.element.find(":input"+b).focus(),this.publish("show")},c.prototype.hide=function(a){return h.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},c.prototype.load=function(a){var b,c,d,e;this.annotation=a,this.publish("load",[this.annotation]),e=this.fields;for(c=0,d=e.length;c<d;c++)b=e[c],b.load(b.element,this.annotation);return this.show()},c.prototype.submit=function(a){var b,c,d,e;h.preventEventDefault(a),e=this.fields;for(c=0,d=e.length;c<d;c++)b=e[c],b.submit(b.element,this.annotation);return this.publish("save",[this.annotation]),this.hide()},c.prototype.addField=function(b){var c,d,e;d=a.extend({id:"annotator-field-"+h.uuid(),type:"input",label:"",load:function(){},submit:function(){}},b),e=null,c=a('<li class="annotator-item" />'),d.element=c[0];switch(d.type){case"textarea":e=a("<textarea />");break;case"input":case"checkbox":e=a("<input />")}return c.append(e),e.attr({id:d.id,placeholder:d.label}),d.type==="checkbox"&&(e[0].type="checkbox",c.addClass("annotator-checkbox"),c.append(a("<label />",{"for":d.id,html:d.label}))),this.element.find("ul:first").append(c),this.fields.push(d),d.element},c.prototype.checkOrientation=function(){var b,d,e;return c.__super__.checkOrientation.apply(this,arguments),e=this.element.find("ul"),b=this.element.find(".annotator-controls"),d=function(){return e.children().each(function(){return a(this).parent().prepend(this)})},this.element.hasClass(this.classes.invert.y)&&e.is(":first-child")?(b.insertBefore(e),d()):b.is(":first-child")&&(b.insertAfter(e),d()),this},c.prototype.processKeypress=function(a){if(a.keyCode===27)return this.hide();if(a.keyCode===13&&!a.shiftKey)return this.submit()},c.prototype.onCancelButtonMouseover=function(){return this.element.find("."+this.classes.focus).removeClass(this.classes.focus)},c.prototype.setupDraggables=function(){var b,c,d,e,f,g,h,i,j,k,l=this;return e=null,b=this.classes,d=this.element,j=null,i=d.find(".annotator-resize"),c=d.find(".annotator-controls"),k=!1,f=function(b){if(b.target===this)return e={element:this,top:b.pageY,left:b.pageX},j=d.find("textarea:first"),a(window).bind({"mouseup.annotator-editor-resize":h,"mousemove.annotator-editor-resize":g}),b.preventDefault()},h=function(){return e=null,a(window).unbind(".annotator-editor-resize")},g=function(a){var f,g,h,l,m;if(e&&k===!1)return f={top:a.pageY-e.top,left:a.pageX-e.left},e.element===i[0]?(l=j.outerHeight(),m=j.outerWidth(),g=d.hasClass(b.invert.x)?-1:1,h=d.hasClass(b.invert.y)?1:-1,j.height(l+f.top*h),j.width(m+f.left*g),j.outerHeight()!==l&&(e.top=a.pageY),j.outerWidth()!==m&&(e.left=a.pageX)):e.element===c[0]&&(d.css({top:parseInt(d.css("top"),10)+f.top,left:parseInt(d.css("left"),10)+f.left}),e.top=a.pageY,e.left=a.pageX),k=!0,setTimeout(function(){return k=!1},1e3/60)},i.bind("mousedown",f),c.bind("mousedown",f)},c}(b.Widget),b.Viewer=function(b){function c(b){this.onDeleteClick=s(this.onDeleteClick,this),this.onEditClick=s(this.onEditClick,this),this.load=s(this.load,this),this.hide=s(this.hide,this),this.show=s(this.show,this),c.__super__.constructor.call(this,a(this.html.element)[0],b),this.item=a(this.html.item)[0],this.fields=[],this.annotations=[]}return t(c,b),c.prototype.events={".annotator-edit click":"onEditClick",".annotator-delete click":"onDeleteClick"},c.prototype.classes={hide:"annotator-hide",showControls:"annotator-visible"},c.prototype.html={element:'<div class="annotator-outer annotator-viewer">\n  <ul class="annotator-widget annotator-listing"></ul>\n</div>',item:'<li class="annotator-annotation annotator-item">\n  <span class="annotator-controls">\n    <button class="annotator-edit">Edit</button>\n    <button class="annotator-delete">Delete</button>\n  </span>\n</li>'},c.prototype.show=function(a){var b,c=this;return h.preventEventDefault(a),b=this.element.find(".annotator-controls").addClass(this.classes.showControls),setTimeout(function(){return b.removeClass(c.classes.showControls)},500),this.element.removeClass(this.classes.hide),this.checkOrientation().publish("show")},c.prototype.isShown=function(){return!this.element.hasClass(this.classes.hide)},c.prototype.hide=function(a){return h.preventEventDefault(a),this.element.addClass(this.classes.hide),this.publish("hide")},c.prototype.load=function(b){var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q;this.annotations=b||[],k=this.element.find("ul:first").empty(),p=this.annotations;for(l=0,n=p.length;l<n;l++){c=p[l],j=a(this.item).clone().appendTo(k).data("annotation",c),e=j.find(".annotator-controls"),g=e.find(".annotator-edit"),f=e.find(".annotator-delete"),d={showEdit:function(){return g.removeAttr("disabled")},hideEdit:function(){return g.attr("disabled","disabled")},showDelete:function(){return f.removeAttr("disabled")},hideDelete:function(){return f.attr("disabled","disabled")}},q=this.fields;for(m=0,o=q.length;m<o;m++)i=q[m],h=a(i.element).clone().appendTo(j)[0],i.load(h,c,d)}return this.publish("load",[this.annotations]),this.show()},c.prototype.addField=function(b){var c;return c=a.extend({load:function(){}},b),c.element=a("<div />")[0],this.fields.push(c),c.element,this},c.prototype.onEditClick=function(a){return this.onButtonClick(a,"edit")},c.prototype.onDeleteClick=function(a){return this.onButtonClick(a,"delete")},c.prototype.onButtonClick=function(b,c){var d;return d=a(b.target).parents(".annotator-annotation"),this.publish(c,[d.data("annotation")])},c}(b.Widget),b=b||{},b.Notification=function(c){function d(b){this.hide=s(this.hide,this),this.show=s(this.show,this),d.__super__.constructor.call(this,a(this.options.html).appendTo(document.body)[0],b)}return t(d,c),d.prototype.events={click:"hide"},d.prototype.options={html:"<div class='annotator-notice'></div>",classes:{show:"annotator-notice-show",info:"annotator-notice-info",success:"annotator-notice-success",error:"annotator-notice-error"}},d.prototype.show=function(c,d){return d==null&&(d=b.Notification.INFO),a(this.element).addClass(this.options.classes.show).addClass(this.options.classes[d]).escape(c||""),setTimeout(this.hide,5e3),this},d.prototype.hide=function(){return a(this.element).removeClass(this.options.classes.show),this},d}(c),b.Notification.INFO="show",b.Notification.SUCCESS="success",b.Notification.ERROR="error",a(function(){var a;return a=new b.Notification,b.showNotification=a.show,b.hideNotification=a.hide})})).call(this);